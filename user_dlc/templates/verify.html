<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>申請審核</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    h2 { font-weight: bold; color: #343a40; }
    .table th, .table td { vertical-align: middle; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .search-bar { display: flex; gap: 1rem; margin-bottom: 20px; }
    .search-bar input { width: 200px; }
    #toast {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(0,0,0,0.75); color: #fff;
      padding: .75rem 1.25rem; border-radius: 8px;
      font-size: .9rem; opacity: 0; pointer-events: none;
      transition: opacity .3s ease-in-out, transform .3s ease-in-out;
      transform: translateY(20px); z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <!-- 標題與登出 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">待審核申請清單</h2>
      <a href="{{ url_for('logout', page='dashboard') }}" class="btn btn-danger btn-sm" style="font-size:15px;">登出</a>
    </div>

    <!-- 搜尋欄 -->
    <div class="search-bar">
      <input type="text" class="form-control" id="searchName" placeholder="搜尋姓名" oninput="filterTable()">
      <input type="text" class="form-control" id="searchPhone" placeholder="搜尋電話" oninput="filterTable()">
      <input type="text" class="form-control" id="searchGmail" placeholder="搜尋 Gmail" oninput="filterTable()">
    </div>

    <!-- 資料表 -->
    <table class="table table-bordered table-hover bg-white shadow-sm" id="requestTable">
      <thead class="table-primary">
        <tr>
          <th>姓名</th><th>Gmail</th><th>人數</th><th>時長</th>
          <th>電話</th><th>剩餘時間</th><th>審核</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requests %}
        <tr>
          <td>{{ req.name }}</td>
          <td>{{ req.gmail }}</td>
          <td>{{ req.count }}</td>
          <td>{{ req.duration }}</td>
          <td>{{ req.phone }}</td>
          <td><span class="timer" data-seconds="{{ req.remaining_seconds }}"></span></td>
          <td>
            {% if not req.otp_sent %}
            <form method="POST" action="{{ url_for('approve', request_id=req.id) }}"
                  onsubmit="return confirmOTP('{{ req.gmail }}', this)">
              <button type="submit" class="btn btn-success btn-sm">核准發送 OTP</button>
            </form>
            {% else %}
              <button class="btn btn-secondary btn-sm" disabled>已送出</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- JS -->
  <script>
    // showToast(msg, type[, duration])
    function showToast(msg, type='info', duration=5000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.background = (type === 'success') ? '#4CAF50'
                       : (type === 'error')   ? '#f44336'
                                              : '#333';
      t.style.transform = 'translateY(0)';
      t.style.opacity = '1';
      setTimeout(() => {
        t.style.opacity = '0';
        t.style.transform = 'translateY(20px)';
      }, duration);
    }

    // 核准按鈕動作
    function disableButton(btn) {
      btn.disabled = true;
      btn.classList.replace('btn-success','btn-secondary');
      btn.textContent = '已送出';
    }
    function confirmOTP(gmail, form) {
      setTimeout(() => showToast('✅ OTP 已發送至 ' + gmail, 'success'), 100);
      disableButton(form.querySelector('button'));
      return true;
    }

    // 倒數計時
    function formatTime(sec) {
      const m = Math.floor(sec/60), s = sec % 60;
      return `${m}分${s}秒`;
    }
    function startCountdown() {
      document.querySelectorAll('.timer').forEach(el => {
        let sec = parseInt(el.dataset.seconds, 10);
        const tick = () => {
          el.textContent = sec > 0 ? formatTime(sec--) : '已過期';
        };
        tick();
        setInterval(tick, 1000);
      });
    }

    // 表格搜尋
    function filterTable() {
      const n = document.getElementById('searchName').value.toLowerCase();
      const p = document.getElementById('searchPhone').value.toLowerCase();
      const g = document.getElementById('searchGmail').value.toLowerCase();
      document.querySelectorAll('#requestTable tbody tr').forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const mail = row.cells[1].textContent.toLowerCase();
        const phone= row.cells[4].textContent.toLowerCase();
        row.style.display = (name.includes(n) && mail.includes(g) && phone.includes(p)) ? '' : 'none';
      });
    }

    // 頁面載入後執行
    window.addEventListener('load', () => {
      // 1) 初始提示
      showToast('✅ 已載入待審申請清單', 'success', 5000);
      // 2) 啟動倒數
      startCountdown();
      // 3) 顯示任何後端 flash 訊息
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          showToast("{{ msg }}", "{{ category }}", 5000);
        {% endfor %}
      {% endwith %}
    });
  </script>
</body>
</html>
